package application;

import javafx.scene.media.Media;
import javafx.scene.media.MediaPlayer;
import javafx.scene.media.MediaPlayer.Status;
import javafx.util.Duration;

import java.io.*;
import java.util.*;

public class Alice {
	LinkedList<File> queue;
	MediaPlayer alice;
	File cur;
	
	boolean loop;
	boolean pause;
	
	/**
	 * Loop the file that are playing
	 * If no file is playing, the method will return 
	 */
	void loop(QueueInfo qi) {
		if(alice.getStatus() == Status.STOPPED) {
			return;
		}
		
		if(!loop) {
			alice.setOnEndOfMedia(new Runnable() {
				@Override
				public void run() {
					alice.seek(Duration.ZERO);
				}
			});
		}else {
			alice.setOnEndOfMedia(new Runnable() {
				@Override
				public void run() {
					alice.stop();
					playNext(qi);
				}
			});
		}
		loop = !loop;
	}
	
	/**
	* play the next file
	*/
	void playNext(QueueInfo qi) {
		if(queue.size() >= 1) {
			cur = queue.removeFirst();
			alice = new MediaPlayer(new Media(cur.toURI().toString()));
			qi.update(queue);
			alice.play();
			alice.setOnEndOfMedia(new Runnable() {
				@Override
				public void run() {
					alice.stop();
					playNext(qi);
				}
			});
		}else {
			loop = false;
		}
	}	
	
	void skip(QueueInfo qi) {
		alice.stop();
		if(!queue.isEmpty()) {
			cur = queue.removeFirst();
			alice = new MediaPlayer(new Media(cur.toURI().toString()));
			qi.update(queue);
			alice.play();
			if(loop) {
				alice.setOnEndOfMedia(new Runnable() {
					@Override
					public void run() {
						alice.seek(Duration.ZERO);
					}
				});
			}else {
				alice.setOnEndOfMedia(new Runnable() {
					@Override
					public void run() {
						alice.stop();
						playNext(qi);
					}
							
				});
			}
		}
	}
	
	void clear() {
		queue = new LinkedList<File>();
	}
	
	void add(File f) {
		queue.addLast(f);
	}
	
	void insert(File f) {
		queue.addFirst(f);
	}
	
	void play(QueueInfo qi) {
		 Status cur = alice.getStatus();
		 if(cur == Status.PAUSED) {
			 alice.play();
			 pause = false;
		 }else if(cur == Status.PLAYING){
			 alice.pause();
			 pause = true;
		 }else if(!queue.isEmpty()) {
			 playNext(qi);
			 pause = false;
		 }
	}
	
	public Alice() {
		queue = new LinkedList<File>();
		alice = new MediaPlayer(new Media("http://www.sovmusic.ru/sam/s12264.mp3"));
		
		
		loop = false;
		pause = true;
	}
}
